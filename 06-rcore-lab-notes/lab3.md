# Lab 3 实验记录

## 从虚拟地址到物理地址

RV64中，使用Sv39模式作为页表的实现。

在Sv39模式中，物理地址有56位，虚拟地址有64位，其中低39位有效，第63-39位的值必须等于第38位的值。

## 分析：页机制的启动过程

1. 修改 `linker.ld`，将基地址从物理地址 `0x80200000` 修改为虚拟地址 `0xffffffff80200000`，并将各段对其到 `4K`

2. 在 `entry.asm` 中，创建大页页表：

   ```asm
       # 初始内核映射所用的页表
       .section .data
       .align 12
   boot_page_table:
       .quad 0
       .quad 0
       # 第 2 项：0x8000_0000 -> 0x8000_0000，0xcf 表示 VRWXAD 均为 1
       .quad (0x80000 << 10) | 0xcf
       .zero 507 * 8
       # 第 510 项：0xffff_ffff_8000_0000 -> 0x8000_0000，0xcf 表示 VRWXAD 均为 1
       .quad (0x80000 << 10) | 0xcf
       .quad 0
   ```

3. 将页表地址减去 `0xffffffff00000000` 来计算页表的物理页号

4. 将页号与 `8 << 60` 做或运算，并将所得结果写入 `satp` 寄存器并刷新 TLB，开启 Sv39 模式的页机制

   **注**：`satp` 寄存器全称：SupervisorAddressTranslationandProtection，监管者地址转换和保护

   在 RV64 中，`satp` 寄存器的值高四位为 MODE，若值为 `0`，表示未开启页机制，`8` 表示开启 Sv39 模式的页机制，`9` 表示开启 Sv48 模式的页机制

   参考文献：[RISC-V 手册 中文版](http://www.riscvbook.com/chinese/RISC-V-Reader-Chinese-v2p1.pdf)

5. 将 `sp` 寄存器的值设为栈顶的虚拟地址

6. 将 `rust_main` 函数的地址存入寄存器并跳转，这里从物理地址跳转到虚拟地址，表示页机制启动完成

   **注**：跳转前 PC 寄存器的值为 `0x80200030`，将要跳转到的地址为 `0xffffffff80204880`。由于 RISC-V 架构中，立即数跳转指令都是使用相对地址，而立即数无法表示这么大的值，所以此处先将 `rust_main` 函数的地址存入寄存器，再使用 `jr` 指令进行跳转

   此外，启动页机制后，PC 寄存器的值仍为物理地址，而此时应该使用虚拟地址，所以在页表中将虚拟地址 `0x0000000080000000` 映射到了物理地址 `0x80000000`，PC 寄存器保持原值不变即可正常执行指令
